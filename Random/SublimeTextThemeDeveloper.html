<!doctype html>
<head><title>Theme Creator for Sublime Text</title>
<style>
	body{
		font-family:'Courier New';
		background-color:#222;
	}
	textarea{
		position:absolute;
		left:0;top:0;width:100%;height:100%;
		border:0;padding:0;
		background-color:#222;
		color:#999;
	}
	div{
		position:absolute;
		left:0;top:0;right:0;bottom:0;
		border:5px solid #222;
		color:#999;
		visibility:hidden;
	}
</style>
</head>
<body>
<textarea id='content'></textarea><div id='results'></div>
<script>
var input=document.getElementById('content');
var output=document.getElementById('results');
var color={};
var templateName='',templateUUID='';
var header=[];
input.onkeydown=function(e){
	if(e.keyIdentifier=='Enter')compile();
};
var compile=function(){
	/* Declaration and instantiation of local variables */
	var gColor=false,gKey=false,gName=false;
	var sColor=0,sKey=0,sName=0;
	var cKey='',cName='',cStr='';
	var iData=input.value;
	var oData="";
	var tab="&nbsp;&nbsp;&nbsp;";
	/* build our color map */
	for(var i=0;i<iData.length;i++){
		if(!gColor && iData[i]=='<' && i+9<iData.length && iData.substring(i,i+9)=='<string>#'){
			gColor=true;sColor=9+i;
		}else if(!gName && iData[i]=='<' && i+8<iData.length && iData.substring(i,i+8)=='<string>'){
			gName=true;sName=8+i;
		}else if(!gKey && iData[i]=='<' && i+5<iData.length && iData.substring(i,i+5)=='<key>'){
			gKey=true;i+=4;sKey=1+i;
		}else if(gKey && iData[i]=='<' && i+6<iData.length && iData.substring(i,i+6)=='</key>'){
			gKey=false;cKey=iData.substring(sKey,i);i+=5;
		}else if(gName && iData[i]=='<'){
			gName=false;cName=iData.substring(sName,i);
		}else if(gColor && iData[i]=='<'){
			cStr=iData.substring(sColor,i);
			if(!color[cStr]){
				color[cStr]={type:[cKey],name:[cName]};
				if(cKey!=='foreground'&&cKey!=='background'){
					templateName=cName;
				} //end if
			}else{
				color[cStr].name.push(cName);
				color[cStr].type.push(cKey);
			} //end if
			gColor=false; //no longer getting a color
			cKey=''; //clear current values	
		} //end if
	} //end if
	templateUUID=cName;
	/* Strip header tags from the color map */
	for(element in color){
		for(var k=0;k<color[element].name.length;k++){
			//Make sure to skip appropriate color mappings
			if(color[element].name[k]!==templateName)continue;
			//Go ahead and push the leftovers into the header
			header.push({color:element,key:color[element].type[k]});
			//and then splice it out of the body
			color[element].name.splice(k,1);
			if(color[element].name.length===0){
				color[element]=undefined;
				break;
			} //end if
		} //end for
	} //end for
	/* Build the XML header */
	oData='&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>';
	oData+='&ltplist version="1.0"&gt;<br/>';
	oData+="&lt;dict&gt;<br/>";
	oData+=tab+"&lt;key&gt;name&lt;/key&gt;<br/>";
	oData+=tab+"&lt;string&gt;"+templateName+"&lt;/string&gt;<br/>";
	oData+=tab+"&lt;key&gt;settings&lt;/key&gt;<br/>";
	oData+=tab+"&lt;array&gt;<br/>";
	oData+=tab+tab+"&lt;dict&gt;<br/>";
	oData+=tab+tab+tab+"&lt;key&gt;settings&lt;/key&gt;<br/>";
	oData+=tab+tab+tab+"&lt;dict&gt;<br/>";
	for(var j=0;j<header.length;j++){
		 oData+=tab+tab+tab+tab+"&lt;key&gt;"+header[j].key+"&lt;/key&gt;<br/>";
		 oData+=tab+tab+tab+tab+"&lt;string&gt;#"+header[j].color+"&lt;/string&gt;<br/>";
	} //end if
	oData+=tab+tab+tab+"&lt;/dict&gt;<br/>";
	oData+=tab+tab+"&lt;/dict&gt;<br/>";
	/* Build the XML body */
	for(element in color){
		if(color[element]==undefined)continue;
		oData+=tab+tab+"&lt;dict&gt;<br/>";
		oData+=tab+tab+tab+"&lt;key&gt;scope&lt;/key&gt;<br/>";
		oData+=tab+tab+tab+"&lt;string&gt;"+color[element].name.join()+"&lt;/string&gt;<br/>";
		oData+=tab+tab+tab+"&lt;key&gt;settings&lt;/key&gt;<br/>";
		oData+=tab+tab+tab+"&lt;dict&gt;<br/>";
		oData+=tab+tab+tab+tab+"&lt;key&gt;"+color[element].type.join()+"&lt;/key&gt;<br/>";
		oData+=tab+tab+tab+tab+"&lt;string&gt;#"+element+"&lt;/string&gt;<br/>";
		oData+=tab+tab+tab+"&lt;/dict&gt;<br/>";
		oData+=tab+tab+"&lt;/dict&gt;<br/>";
	} //end for
	/* Build the XML footer */
	oData+=tab+"&lt;/array&gt;<br/>";
	oData+=tab+"&lt;key&gt;uuid&lt;/key&gt;<br/>";
	oData+=tab+"&lt;string&gt;"+templateUUID+"&lt;/string&gt;<br/>";
	oData+="&lt;/dict&gt;<br/>";
	oData+="&lt;/plist&gt;";
	/* Throw the XML data into the output now that it's finished */
	output.innerHTML=oData;
	/* Adjust the visibility flags */
	input.style.visibility='hidden';
	output.style.visibility='visible';
};
</script>
</body>
</html>