<!doctype html><head><title>Side Scroller</title></head><body>
<script type='text/javascript' src='libs/easel.js'></script>
<script type='text/javascript' src='libs/ion.dev.js'></script>
<script type='text/javascript' src='libs/mousetrap.min.js'></script>
<script>
var assets={
  brick:[
    [0,    0,   0.5, 0.3],
    [0.55, 0,   0.45,0.3],
    [0,    0.35,0.2, 0.3],
    [0.25, 0.35,0.5, 0.3],
    [0.8,  0.35,0.2, 0.3],
    [0,    0.7, 0.5, 0.3],
    [0.55, 0.7, 0.45,0.3]
  ],
  scale: 50,
  grass:{ color: '#F82' }
};
function drawAsset(o,x,y){
  var i=0,
      x,y,w,h;

  for(;i<o.length;i++){
    x = o[i][0]*assets.scale+x;
    y = o[i][1]*assets.scale+y;
    w = o[i][2]*assets.scale;
    h = o[i][3]*assets.scale
    ctx.fillRect(x,y,w,h);
  } //end for
};
//The player object
var player={
  x:v.w/2, //x location
  y:0, //y location
  w:50, //width of player
  h:50, //height of player
  s:1, //speed of the player
  c:'#BDB', //color of player
  key:{ //key activation must be smooth and staged so multiple keys can be pressed at the same time
    right:false,
    up:false,
    left:false
  },
  jump:{
    is:false, //are we currently jumping
    d:1, //direction of jump
    a:100, //destination jump value
    c:0,  //current jump value
    s:0.1 //speed of the
  },
  dirty:[]
};
//All actions
var action={
  jump:function jump(object){
    if(object.jump.d==1){
      object.jump.is=true;
      object.dirty.push(function(){object.jump.c++;});
      if(object.jump.c==object.jump.a)object.jump.d=0;
    }else{
      object.dirty.push(function(){object.jump.c--;});
    } //end if
    if(object.jump.c!==0||object.jump.d==1){
      setTimeout(function(){action.jump(object);},1);
    }else{
      object.jump.is=false;object.jump.d=1;
    } //end if
  }
};
//the main drawing function
var draw=function draw(){
  //Handle the key staging
  if(player.key.left){
    if(player.x-player.w/2-1>0){ //player can't walk off the screen
      player.dirty.push(function(){player.x-=player.s;});
    } //end if
  } //end if
  if(player.key.right){
    if(player.x+player.w/2+1<v.w){ //player can't walk off the screen
      player.dirty.push(function(){player.x+=player.s;});
    } //end if
  } //end if
  if(player.key.up){
    if(!player.jump.is)action.jump(player);
  } //end if
  //draw the ground
  for(var i=0;i<v.w/assets.scale;i++){
    ctx.fillStyle='#833';
    ctx.fillRect(i*assets.scale,v.h-assets.scale,50,50);
    ctx.fillStyle=assets.grass.color;
    drawAsset(assets.brick,i*assets.scale,v.h-assets.scale);
  } //end for
  //draw the player
  if(player.dirty.length>0){
    ctx.fillStyle='#000';
    ctx.fillRect(player.x-player.w/2,v.h-assets.scale-player.h-player.y-player.jump.c,player.w,player.h);
    for(operation in player.dirty){
      player.dirty[operation]();
    } //end for
    player.dirty=[];
  } //end if
  ctx.fillStyle=player.c;
  ctx.fillRect(player.x-player.w/2,v.h-assets.scale-player.h-player.y-player.jump.c,player.w,player.h);
  setTimeout('draw()',1);
};

//Event handlers
(function(){
  Mousetrap.bind(['w','up'],function(){player.key.up=true;});
  Mousetrap.bind(['w','up'],function(){player.key.up=false;},'keyup');
  Mousetrap.bind(['d','right'],function(){player.key.right=true;});
  Mousetrap.bind(['d','right'],function(){player.key.right=false;},'keyup');
  Mousetrap.bind(['a','left'],function(){player.key.left=true;});
  Mousetrap.bind(['a','left'],function(){player.key.left=false;},'keyup');
  draw();
})();
</script>
</body></html>
